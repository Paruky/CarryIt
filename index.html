<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>CarryIt</title>
    <style>
        html, body {
            touch-action: manipulation;
        }
        img {
            display: none;
        }
        body {
            margin: 0;
            background-image: url(imgWall.png);
            background-size: 40px 40px;
        }
        button {
            position: absolute;
            top: 600px;
            left: 300px;
            z-index: 10;
            rotate: 90deg;
            font-size: 16px;
            padding: 10px 15px;
        }
        #down {
            left: 250px;
        }
        #up {
            left: 350px;
        }
        #left {
            left: 300px;
            top: 550px;
        }
        #right {
            left: 300px;
            top: 650px;
        }
    </style>
    <script>
        "use strict";
        const data = [
            // 迷路データ（0：通路、1：目的地、2：荷物、6：壁 ）
            [6,6,6,6,6,6,6,6,6,6,6],
            [6,6,6,0,0,6,6,6,6,6,6],
            [6,6,6,2,0,6,6,6,6,6,6],
            [6,6,6,0,0,0,0,6,6,6,6],
            [6,6,6,0,6,6,0,6,6,6,6],
            [6,0,0,2,0,0,2,0,2,0,6],
            [6,0,6,0,6,6,0,0,0,0,6],
            [6,0,6,0,6,6,0,2,0,0,6],
            [6,0,6,0,6,6,2,6,6,6,6],
            [6,0,6,0,0,0,0,6,6,6,6],
            [6,0,0,0,6,6,6,6,6,6,6],
            [6,6,6,0,6,6,6,6,6,6,6],
            [6,6,0,0,6,6,6,6,6,6,6],
            [6,6,6,0,6,6,6,6,6,6,6],
            [6,6,0,0,0,6,6,6,6,6,6],
            [6,6,0,0,0,6,6,6,6,6,6],
            [6,6,1,1,1,6,6,6,6,6,6],
            [6,6,1,1,1,6,6,6,6,6,6],
            [6,6,6,6,6,6,6,6,6,6,6],
            [6,6,6,6,6,6,6,6,6,6,6],
        ];
        let gc = null
        let px = 2
        let py = 12
        let bsize = 40


        function init() {;
            gc = document.getElementById("soko").getContext("2d");
            window.onkeydown = mykeydown;
            repaint();
        }

        function mykeydown(e) { //キーを押された時の動き
            let dx0 = px
            let dy0 = py
            let dx1 = px
            let dy1 = py
            switch (e.keyCode) {
                case 40:
                    dx0--
                    dx1 -= 2
                    break
                case 37:
                    dy0--
                    dy1 -= 2
                    break
                case 38:
                    dx0++
                    dx1 += 2
                    break
                case 39:
                    dy0++
                    dy1 += 2
                    break
            }

            if ((data[dy0][dx0] & 0x2) == 0) {
                px = dx0
                py = dy0
            } else if ((data[dy0][dx0] & 0x6) == 2) {
                if ((data[dy1][dx1] & 0x2) == 0) {
                    data[dy0][dx0] ^= 2
                    data[dy1][dx1] |= 2
                    px = dx0
                    py = dy0
                }
            }

            repaint()
        }

        function mybtndown(e) { //ボタンを押された時の動き
            let dx0 = px
            let dy0 = py
            let dx1 = px
            let dy1 = py
            switch (e.keyCode) {
                case 40:
                    dx0--
                    dx1 -= 2
                    break
                case 37:
                    dy0--
                    dy1 -= 2
                    break
                case 38:
                    dx0++
                    dx1 += 2
                    break
                case 39:
                    dy0++
                    dy1 += 2
                    break
            }

            if ((data[dy0][dx0] & 0x2) == 0) {
                px = dx0
                py = dy0
            } else if ((data[dy0][dx0] & 0x6) == 2) {
                if ((data[dy1][dx1] & 0x2) == 0) {
                    data[dy0][dx0] ^= 2
                    data[dy1][dx1] |= 2
                    px = dx0
                    py = dy0
                }
            }

            repaint()
        }

        function repaint() {
            gc.fillStyle = "black";
            gc.fillRect(0, 0, 440, 800);

            for (let y=0; y<data.length; y++) {
                for (let x=0; x<data[y].length; x++) {
                    if (data[y][x] & 0x1) {
                        gc.drawImage(imgGoal, x * bsize, y * bsize, bsize, bsize);
                    }
                    if (data[y][x] & 0x2) {
                        gc.drawImage(imgLuggage, x * bsize, y * bsize, bsize, bsize);
                    }
                    if (data[y][x] == 6) {
                        gc.drawImage(imgWall, x * bsize, y * bsize, bsize, bsize);
                    }
                }
            }
            gc.drawImage(imgWorker, px * bsize, py * bsize, bsize, bsize);
        }
    </script>
</head>
<body onload="init()">
    <canvas id="soko" width="440" height="800"></canvas>
    <img id="imgWall" src="imgWall.png">
    <img id="imgGoal" src="imgGoal.png">
    <img id="imgWorker" src="imgWorker.png">
    <img id="imgLuggage" src="imgLuggage.png">
    <button id="left" onclick="mybtndown({keyCode:37})">左</button>
    <button id="right" onclick="mybtndown({keyCode:39})">右</button>
    <button id="up" onclick="mybtndown({keyCode:38})">上</button>
    <button id="down" onclick="mybtndown({keyCode:40})">下</button>
</body>
</html>